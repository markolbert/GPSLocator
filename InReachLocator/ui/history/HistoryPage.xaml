<Page
    x:Class="J4JSoftware.InReach.HistoryPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:J4JSoftware.InReach"
    xmlns:map="using:MapControl"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:sfcal="using:Syncfusion.UI.Xaml.Calendar"
    xmlns:sfgrid="using:Syncfusion.UI.Xaml.DataGrid"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance local:HistoryViewModel}"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">

    <Grid x:Name="OuterContainer">

        <Grid.Resources>

            <Style TargetType="TextBlock">
                <Setter Property="Margin" Value="14,7,14,7"/>
                <Setter Property="VerticalAlignment" Value="Top"/>
            </Style>

            <Style TargetType="sfcal:SfCalendar">
                <Setter Property="Margin" Value="14,7,14,7"></Setter>
            </Style>

            <Style TargetType="sfgrid:SfDataGrid">
                <Setter Property="Margin" Value="14,7,14,7"></Setter>
            </Style>

            <Style x:Key="PushpinRowStyle" TargetType="sfgrid:DataGridRowControl">
                <Setter Property="Background" Value="AliceBlue"/>
                <Setter Property="FontWeight" Value="Bold"/>
            </Style>

            <Style x:Key="RoutePointRowStyle" TargetType="sfgrid:DataGridRowControl">
                <Setter Property="Background" Value="LightGoldenrodYellow"/>
                <Setter Property="FontWeight" Value="Bold"/>
            </Style>

            <Style x:Key="PushpinItemStyle" TargetType="map:MapItem">
                <Setter Property="AutoCollapse" Value="True"/>
                <Setter Property="LocationMemberPath" Value="DisplayPoint"/>
                <Setter Property="HorizontalAlignment" Value="Center"/>
                <Setter Property="VerticalAlignment" Value="Bottom"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="map:MapItem">
                            <map:Pushpin Content="{Binding Label, FallbackValue=?}"
                                         HorizontalAlignment="{TemplateBinding HorizontalAlignment}"/>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <DataTemplate x:Key="RouteTemplate">
                <map:MapPolyline Locations="{Binding Locations}" Stroke="Red" StrokeThickness="3"/>
            </DataTemplate>

        </Grid.Resources>

        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="Auto" MaxWidth="410"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Grid.Column="0">Start Date</TextBlock>
        <sfcal:SfCalendar Grid.Row="0" Grid.Column="1"
                          x:Name="StartCalendar"
                          SelectedDate="{Binding StartDate, Mode=TwoWay}"
                          MinDate="{Binding MinimumStartDate}"/>

        <TextBlock Grid.Row="1" Grid.Column="0">End Date</TextBlock>
        <sfcal:SfCalendar Grid.Row="1" Grid.Column="1"
                          SelectedDate="{Binding EndDate, Mode=TwoWay}"/>

        <StackPanel Grid.Row="0" Grid.Column="2" Orientation="Vertical">

            <sfgrid:SfDataGrid x:Name="LocationsGrid" 
                               MaxHeight="300"
                               Width="410"
                               RowHeight="40"
                               SelectionMode="Extended"
                               HorizontalAlignment="Left"
                               VerticalAlignment="Top"
                               Visibility="{Binding Path=HasPoints, Converter={StaticResource BoolToVisibilityConverter }}"
                               ItemsSource="{Binding MapPoints}"
                               SelectedItems="{Binding SelectedMapPoints}"
                               AutoGenerateColumns="False"
                               AllowResizingColumns="True">

                <sfgrid:SfDataGrid.Columns>
                    <sfgrid:GridDateColumn MappingName="InReachLocation.Timestamp" 
                                           HeaderText="Timestamp"
                                           DisplayDateFormat="MM/dd/yyyy HH:mm:ss"/>
                </sfgrid:SfDataGrid.Columns>

            </sfgrid:SfDataGrid>

            <StackPanel Orientation="Horizontal"
                        Visibility="{Binding HasPoints, Converter={StaticResource BoolToVisibilityConverter}}">

                <Button Command="{Binding ChangeSelectedMapPointsCommand}">
                    <Button.CommandParameter>
                        <local:LocationType>Pushpin</local:LocationType>
                    </Button.CommandParameter>
                    -> Pushpin(s)
                </Button>

                <Button Command="{Binding ChangeSelectedMapPointsCommand}">
                    <Button.CommandParameter>
                        <local:LocationType>RoutePoint</local:LocationType>
                    </Button.CommandParameter>
                    -> Route Point(s)
                </Button>

                <Button Command="{Binding ChangeSelectedMapPointsCommand}">
                    <Button.CommandParameter>
                        <local:LocationType>Unspecified</local:LocationType>
                    </Button.CommandParameter>
                    -> Hidden
                </Button>

            </StackPanel>
        </StackPanel>

        <local:LocationControl Grid.Row="1" Grid.Column="2" 
                               Visibility="{Binding ElementName=OuterContainer, Path=DataContext.MapPointToDisplay, Converter={StaticResource ObjectToVisibilityConverter }}"
                               DataContext="{Binding MapPointToDisplay.InReachLocation, FallbackValue=null}" />

        <map:Map Grid.Row="0" Grid.Column="3" Grid.RowSpan="3" 
                 x:Name="TestMap" 
                 ManipulationMode="All"
                 MinZoomLevel="2" 
                 MaxZoomLevel="21" 
                 ZoomLevel="12"
                 Visibility="{Binding MapCenter, Converter={StaticResource ObjectToVisibilityConverter}}"
                 Center="{Binding MapCenter, Mode=TwoWay}">

            <!--<map:Map.Center>
                <map:Location Latitude="36.977405" Longitude="-122.015833"/>
            </map:Map.Center>-->

            <map:MapTileLayer SourceName="OpenStreetMap"
                              Description="© [OpenStreetMap contributors](http://www.openstreetmap.org/copyright)">

                <map:MapTileLayer.TileSource>
                    <map:TileSource UriFormat="https://tile.openstreetmap.org/{z}/{x}/{y}.png"/>
                </map:MapTileLayer.TileSource>

            </map:MapTileLayer>

            <map:MapItemsControl ItemsSource="{Binding Pushpins}"
                                 ItemContainerStyle="{StaticResource PushpinItemStyle}"/>

            <map:MapItemsControl ItemsSource="{Binding Route}"
                                 ItemTemplate="{StaticResource RouteTemplate}"/>

        </map:Map>

    </Grid>
</Page>
